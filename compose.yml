networks:
  dockercraft:
    driver: bridge

services:

  # API Backend (fastapi)
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: dockercraft-api
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app
      - ./data:/data
      - ./config:/config
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PYTHONUNBUFFERED=1
      - DATA_PATH=/data
      - RCON_PASSWORD=${RCON_PASSWORD:-changeme}
    networks:
      - dockercraft
    restart: unless-stopped

  # Web UI (nginx)
  web:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    container_name: dockercraft-web
    ports:
      - "8080:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
    networks:
      - dockercraft
    depends_on:
      - api
    restart: unless-stopped

  # Redis (for task queues)
  redis:
    image: redis:alpine
    container_name: dockercraft-redis
    networks:
      - dockercraft
    restart: unless-stopped

  # Minecraft Server (dynamically created)
  # This is a template - actual servers created via API
  # minecraft:
  #   build:
  #     context: .
  #     dockerfile: docker/minecraft/Dockerfile
  #   container_name: dockercraft-minecraft-{instance}
  #   ports:
  #     - "25565:25565"
  #     - "25575:25575"
  #   volumes:
  #     - ./data/instances/{instance}:/minecraft
  #   environment:
  #     - MEMORY_MIN=4G
  #     - MEMORY_MAX=8G
  #     - RCON_PASSWORD=${RCON_PASSWORD}
  #     - RCON_PORT=25575
  #   networks:
  #     - dockercraft
  #   restart: unless-stopped

  # OLD - TODO: remove
  # dockercraft:
  #   build: .
  #   container_name: dockercraft
  #   ports:
  #     - "25565:25565"
  #   volumes:
  #     - ./server.jar:/minecraft/server.jar
  #     - ./backups:/minecraft/backups
  #     - ./logs:/minecraft/logs
  #     - ./fifo:/minecraft/fifo
  #     - ./server:/minecraft
  #   environment:
  #     - SERVER_PATH=/minecraft
  #     - FIFO_PATH=fifo
  #     - BACKUP_DIR=backups
  #     - LOG_DIR=logs
  #     - MEMORY_MIN=4G
  #     - MEMORY_MAX=8G
  #     - MAX_LOGS=10
  #     - MAX_BACKUPS=10
  #   restart: unless-stopped
  #   stdin_open: true
  #   tty: true
